# stop if cmake version below 3.10.2
cmake_minimum_required(VERSION 3.10.2 FATAL_ERROR)

# Generate folders for IDE's
set_property(GLOBAL PROPERTY USE_FOLDERS ON)


###########
# Project #
###########

project(
  EnvTest
  VERSION 1.0.0
  LANGUAGES CXX
)

# Disable project in-source buils
if("${PROJECT_SOURCE_DIR}" STREQUAL "${PROJECT_BINARY_DIR}")
   message(SEND_ERROR "In-source builds are not permitted. Use a separate folder for building. Unfortunately some files might have been generated by cmake in this directory, please delete those before continuing.")
endif("${PROJECT_SOURCE_DIR}" STREQUAL "${PROJECT_BINARY_DIR}")

###################
# custom commands #
###################

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/BuildEnv.txt
  COMMAND set > ${CMAKE_CURRENT_BINARY_DIR}/BuildEnv.txt
  DEPENDS dummy.txt
  COMMENT "Dumping environment"
)

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/GenFile1.txt
  COMMAND TestCommand.bat ${CMAKE_CURRENT_BINARY_DIR}/GenFile1.txt
  DEPENDS dummy2.txt
  COMMENT "Generating file"
)

######################
# Content for Target #
######################

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/content_deps.txt
  POST_BUILD
  COMMAND ${CMAKE_COMMAND} -E touch
    ${CMAKE_CURRENT_BINARY_DIR}/content_deps.txt
  DEPENDS 
    ${CMAKE_CURRENT_BINARY_DIR}/BuildEnv.txt
    ${CMAKE_CURRENT_BINARY_DIR}/GenFile1.txt
)

##########
# Target #
##########

# Add all the include and source files to the library
add_executable(EnvTest
  source/main.cpp
  ${CMAKE_CURRENT_BINARY_DIR}/content_deps.txt
)

# Location of header files in this package
target_include_directories(EnvTest
  PRIVATE
    $<INSTALL_INTERFACE:source>
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/source>
)


#######################
# Target Dependencies #
#######################


target_compile_features(EnvTest
  PUBLIC
    cxx_std_14 # Enable C++14
)

if ("${CMAKE_CXX_COMPILER_ID}" STREQUAL "MSVC")
  target_compile_options(EnvTest PRIVATE /W3 /MP)
endif()
